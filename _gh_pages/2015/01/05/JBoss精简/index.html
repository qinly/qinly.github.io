
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>JBoss精简优化</title>
    <meta name="description" content="">
    <meta name="author" content="GuoQing. Lai.">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap styles -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional theme -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Sticky Footer -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bs-sticky-footer.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <link href="/assets/themes/bootstrap-3/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div id="wrap">
      <nav class="navbar navbar-default" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#jb-navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Qing 个人博客</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="jb-navbar-collapse">
          <ul class="nav navbar-nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/test.html">测试页面</a></li>
      	
      
    
  



          </ul>
          <form class="navbar-form navbar-right" role="search">
            <div class="form-group">
              <input type="text" class="form-control" placeholder="Search">
            </div>
            <button type="submit" class="btn btn-default">Submit</button>
          </form>
        </div><!-- /.navbar-collapse -->
      </nav>

      <div class="container">
        
<div class="page-header">
  <h1>JBoss精简优化 </h1>
</div>

<div class="row post-full">
  <div class="col-xs-12">
    <div class="date">
      <span>05 January 2015</span>
    </div>
    <div class="content">
      
<p>JBoss应用服务器优化<br />
原文地址:<a href="http://wangtong40.iteye.com/blog/737235">原文</a></p>

<h2 id="java-opts">Java OPTS设置</h2>

<p>在Java的Jvm分为主要为两大块：一个是heap和 nheap
Heap包括三个区域. Eden space、survivor space、tenured space.<br />
其中surivor space包括两个区，一个是from区，一个是to区
Eden是负责新对象的创建区域。当新对象无法在eden区创建的时候，eden区会进行minor gc,会将一些失效的对象清除。会将清除下来的部分对象放到survivor space区域或者tenured space区域。当tenured space的对象越来越多的时候，达到jvm内存不足10%的时候，会进行一次full gc来释放对象。项目要尽可能少的full gc ,应为full gc比较占用内存，一般要求吞吐量比较大的时候，尽量的将new区域设置的比较大一点。也就是eden和survivor这个区域。
下面简要的说一下配置参数</p>

<pre><code>set JAVA_OPTS=%JAVA_OPTS% -Xms128m -Xmx512m -XX:MaxPermSize=256m
</code></pre>

<p>-Xms512m 代表jvm最少用512m内存,32bit操作系统最大在1.5g-2g之间，64位的无限制。<br />
-Xmx1024m 代表jvm最多使用1024m内存<br />
尽量的将-Xms和-Xmx大小设置相同，这样避免内存重新分配影响性能</p>

<p>-Xss=128k 线程初始化大小，5.0之前默认是128k,之后为1m,线程机器最大为3000-5000<br />
-XX:MaxPermSize=256m：这是表明持久类（也就是noheap区域）的最大为256m<br />
-XX:PermSize=256m这个持久区域初始化为256m，一般持久类的大小是64m，这个配置是最常用的配置。<br />
如果需要考虑到吞吐量，那么new space和old space你就得重新分配一下</p>

<p>Jvm垃圾收集器包括三种：串行，并行，并发
串行：处理小型数据，jdk1.4之前默认使用
并行：1.5和1.5之后使用，<br />
处理典型服务器配置有以下几种：<br />
-Xmx3800m -Xms3800m -Xmn2g -Xss128k -XX:+UseParallelGC -XX:ParallelGCThreads=20</p>

<p>-XX:+UseParallelGC：选择垃圾收集器为并行收集器。此配置仅对年轻代有效。即上述配置下，年轻代使用并发收集，而年老代仍旧使用串行收集。
-XX:ParallelGCThreads=20：配置并行收集器的线程数，即：同时多少个线程一起进行垃圾回收。此值最好配置与处理器数目相同</p>

<p>-Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:+UseParallelGC -XX:ParallelGCThreads=20 -XX:+UseParallelOldGC</p>

<p>-XX:+UseParallelOldGC：配置年老代垃圾收集方式为并行收集。JDK6.0支持对年老代并行收集。<br />
-Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:+UseConcMarkSweepGC -XX:CMSFullGCsBeforeCompaction=5 -XX:+UseCMSCompactAtFullCollection</p>

<p>XX:CMSFullGCsBeforeCompaction：此值设置运行多少次GC以后对内存空间进行压缩、整理。由于并发收集器不对内存空间进行压缩、整理，所以运行一段时间以后会产生“碎片”，使得运行效率降低。<br />
-XX:+UseCMSCompactAtFullCollection：打开对年老代的压缩。可能会影响性能，但是可以消除碎片</p>

<h2 id="section">常见配置汇总</h2>

<ol>
  <li>堆设置<br />
-Xss128k：JBoss每增加一个线程（thread)就会立即消耗128K,默认值好像是512k.<br />
-Xms512m:初始堆大小,代表jvm最少用 512m内存<br />
-Xmx:最大堆大小 一般为服务器的3/4内存量，推荐至少使用4G内存，不应该超过物理内存的90％<br />
-XX:NewSize=n:设置年轻代大小<br />
-XX:NewRatio=n:设置年轻代和年老代的比值。如:为3，表示年轻代与年老代比值为1：3，年轻代占整个年轻代年老代和的1/4<br />
-XX:SurvivorRatio=n:年轻代中Eden区与两个Survivor区的比值。注意Survivor区有两个。如：3，表示Eden：Survivor=3：2，一个Survivor区占整个年轻代的1/5<br />
-XX:MaxPermSize=n:设置持久代大小</li>
  <li>收集器设置<br />
-XX:+UseSerialGC:设置串行收集器<br />
-XX:+UseParallelGC:设置并行收集器<br />
-XX:+UseParalledlOldGC:设置并行年老代收集器<br />
-XX:+UseConcMarkSweepGC:设置并发收集器</li>
  <li>垃圾回收统计信息<br />
-XX:+PrintGC
-XX:+PrintGCDetails
-XX:+PrintGCTimeStamps
-Xloggc:filename</li>
  <li>并行收集器设置<br />
-XX:ParallelGCThreads=n:设置并行收集器收集时使用的CPU数。并行收集线程数。
-XX:MaxGCPauseMillis=n:设置并行收集最大暂停时间
-XX:GCTimeRatio=n:设置垃圾回收时间占程序运行时间的百分比。公式为1/(1+n)</li>
  <li>并发收集器设置
-XX:+CMSIncrementalMode:设置为增量模式。适用于单CPU情况。
-XX:ParallelGCThreads=n:设置并发收集器年轻代收集方式为并行收集时，使用的CPU数。并行收集线程数。
查看CPU数
cat /proc/cpuinfo | grep “processor” | wc -l
生产环境8G内存jboss配置如下
Java代码  收藏代码</li>
</ol>

<p><code>
    if [ "x$JAVA_OPTS" = "x" ]; then   
       JAVA_OPTS="-Xss128k -Xms6000m -Xmx6000m -XX:MaxNewSize=512m -XX:MaxPermSize=512M -XX:+UseParallelGC -XX:ParallelGCThreads=16 -XX:+UseParallelOldGC -Dsun.rmi.dgc.client.gcInterval=3600000 -Dsun.rmi.dgc.server.gcInterval=3600000"   
    fi   
</code>
生产环境4G内存jboss配置如下<br />
` 
    if [ “x$JAVA_OPTS” = “x” ]; then <br />
       JAVA_OPTS=”-Xss128k -Xms3000m -Xmx3000m -XX:MaxNewSize=256m -XX:MaxPermSize=256m -XX:+UseParallelGC -XX:ParallelGCThreads=16 -XX:+UseParallelOldGC -Dsun.rmi.dgc.client.gcInterval=3600000 -Dsun.rmi.dgc.server.gcInterval=3600000” <br />
    fi
`</p>

<p>数据库连接
在JBOSS_HOME\Server\default\deploy目录下存在<strong>-xa-ds.xml文件，用于JBOSS同数据库连接等配置，默认情况下</strong>-xa-ds.xml文件中不包含关于数据库连接池等方面的配置信息，可以添加一下内容进行数据库连接池方面的设置：</p>

<pre><code>&lt;min-pool-size&gt;100&lt;/min-pool-size&gt;   
&lt;max-pool-size&gt;500&lt;/max-pool-size&gt;    
</code></pre>

<p>第3章 Tomcat1 web.xml</p>

<p>修改Tomcat的JSP自动编译配置项,修改如下代码：
<code>%JBOSS_HOME%/deploy/jbossweb-tomcat50.sar/conf/web.xml</code></p>

<pre><code>&lt;servlet&gt;  
&lt;servlet-name&gt;jsp&lt;/servlet-name&gt;  
&lt;servlet-class&gt;org.apache.jasper.servlet.JspServlet&lt;/servlet-class&gt;  
&lt;init-param&gt;  
&lt;param-name&gt;development&lt;/param-name&gt;  
&lt;param-value&gt;false&lt;/param-value&gt;  
&lt;/init-param&gt;  
&lt;/servlet&gt;
</code></pre>

<p>追加<code>development=false</code>
通知tomcat在用户访问时不必作JSP文件是否已被修改的检查。<br />
2 se    ver.xml
修改Tomcat的server.xml文件，设置线程数、支持压缩协议等…</p>

<p>%JBOSS_HOME%/deploy/jbossweb-tomcat50.sar/server.xml</p>

<pre><code>&lt;Connector port="80" address="0.0.0.0"  
maxThreads="75" maxHttpHeaderSize="8192"  
minSpareThreads="55" maxSpareThreads="25"  
enableLookups="false" redirectPort="8443" acceptCount="100"  
connectionTimeout="20000" disableUploadTimeout="true"  
compression="on" compressableMimeType="text/html,text/xml,text/plain,text/css,  
text/javascript,application/xhtml+xml,application/x-javascript,application/javascript,text/xhtml"  
/&gt;  
</code></pre>

<h2 id="section-1">第4章    日志优化</h2>
<p>优化JBOSS日志：%JBOSS_HOME%/server/default/conf/log4j.xml
4.1    修改Append</p>

<p>修改以下内容：
```XML
  <span><param name="Append" value="true" /></span></p>
<param name="Threshold" value="WARN" />

<p>```</p>

<p>修改后的代码如下：</p>

<pre><code>&lt;appender name="FILE" class="org.jboss.logging.appender.DailyRollingFileAppender"&gt;  
&lt;errorHandler class="org.jboss.logging.util.OnlyOnceErrorHandler"/&gt;  
&lt;param name="File" value="${jboss.server.home.dir}/log/server.log"/&gt;  
&lt;param name="Append" value="true"/&gt;  
&lt;param name="Threshold" value="WARN"/&gt;  
&lt;param name="DatePattern" value="'.'yyyy-MM-dd"/&gt;  
&lt;layout class="org.apache.log4j.PatternLayout"&gt;  
&lt;param name="ConversionPattern" value="%d %-5p [%c] %m%n"/&gt;  
&lt;/layout&gt;  
&lt;/appender&gt; 
</code></pre>

<p>4.2    修改Root<br />
	关闭控制台日志输出：屏蔽：<appender-ref ref="CONSOLE"></appender-ref></p>

<pre><code>&lt;root&gt;  
&lt;!--&lt;appender-ref ref="CONSOLE"/&gt;--&gt;  
&lt;appender-ref ref="FILE"/&gt;  
&lt;/root&gt;  
</code></pre>

<h2 id="jboss">JBOSS瘦身</h2>
<p>在JBOSS中提供许多通常不需要的服务和Jar包，比如JMX、Mail、AOP、Hibernate等，可以根据具体项目所涉及的技术，删减JBOSS内置应用，从而提高JBOSS中间件启动速度，减少占用系统资源。</p>

<p>删减服务<br />
在<code>%JBOSS_HOME%/server/default/deploy</code>中含有一些比如jboss-aop.deployer等目录和mail-service.xml等应用配置文件，如果不需要使用这些应用的话，可以将其一一删除，不过删除时要分外小心，避免应用系统无法启动。
下图为只包含数据库应用的一个已删减不需要服务后的deploy文件夹目录：</p>

<p>删减Jar包<br />
在<code>%JBOSS_HOME%/server/default/lib</code>中包含一些应用系统不需要的Jar包，这些包同样可以进行删除。</p>

    </div>

    

  
    <ul class="tag_box inline">
      <li><i class="glyphicon glyphicon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#JAVA WEB-ref">JAVA WEB <span>6</span></a></li>
    
  



    </ul>
    
  
    <hr>
    <ul class="pagination">
    
      <li class="prev disabled"><a>&larr; Previous</a></li>
    
      <li><a href="/archive.html">Archive</a></li>
    
      <li class="next"><a href="/2015/01/05/JavaScript%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95" title="JavaScript 对象方法、属性">Next &raquo;</a></li>
    
    </ul>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>请启动JavaScript脚本 <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">博客评论使用 <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


      </div>

    </div>

    <!-- 
    <div id="footer">
      <div class="container">
        <p>&copy; 2015 GuoQing. Lai.
        </p>
      </div>
    </div> 
    -->

    <footer class="footer">

  <p>&lt;3</p>
  <!-- 
  <p>Heavily inspired by <a href="https://github.com/necolas/idiomatic-css">Idiomatic CSS</a> and the <a href="http://github.com/styleguide">GitHub Styleguide</a>. Made with all the love in the world by <a href="https://twitter.com/mdo">@mdo</a>.</p>
 -->
  <p>Open sourced under MIT. Copyright 2015 <a href="https://twitter.com/mdo">@mdo</a>.</p>
  
<!-- 
  <ul class="quick-links">
    <li>
      <iframe class="github-btn" src="http://ghbtns.com/github-btn.html?user=mdo&repo=code-guide&type=watch&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="112px" height="20px"></iframe>
    </li>
    <li>
      <iframe class="github-btn" src="http://ghbtns.com/github-btn.html?user=mdo&repo=code-guide&type=fork&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="98px" height="20px"></iframe>
    </li>
  </ul>
  <ul class="quick-links">
    <li class="follow-btn">
      <a href="https://twitter.com/mdo" class="twitter-follow-button" data-link-color="#0069D6" data-show-count="true">Follow @mdo</a>
    </li>
    <li class="tweet-btn">
      <a href="https://twitter.com/share" class="twitter-share-button" data-url="" data-count="horizontal" data-via="mdo">Tweet</a>
    </li>
  </ul>
   -->
   
</footer>


    


    <!-- Latest compiled and minified JavaScript, requires jQuery 1.x (2.x not supported in IE8) -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="/assets/themes/bootstrap-3/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>

